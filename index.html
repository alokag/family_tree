<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Tree - Vanilla JS</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; background: var(--bg); }
        
        header { 
            position: fixed; top: 0; width: 100%; padding: 15px; 
            background: white; border-bottom: 1px solid #ddd; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }

        #viewport { width: 100vw; height: 100vh; overflow: auto; cursor: grab; position: relative; }
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #nodes-container { position: absolute; width: 5000px; height: 5000px; }

        .node {
            position: absolute; width: 150px; background: var(--card);
            padding: 12px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            text-align: center; border: 1px solid #e2e8f0; z-index: 10;
        }
        .node.me { border: 2px solid var(--primary); box-shadow: 0 0 10px rgba(37, 99, 235, 0.3); }

        .node-img { width: 50px; height: 50px; background: #e2e8f0; border-radius: 50%; margin: 0 auto 8px; object-fit: cover; }
        .node-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; }
        
        /* 4-Direction Buttons */
        .btn-add {
            position: absolute; width: 22px; height: 22px; background: var(--primary);
            color: white; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 16px; cursor: pointer; border: 2px solid white;
        }
        .btn-top { top: -11px; left: 50%; transform: translateX(-50%); }
        .btn-bottom { bottom: -11px; left: 50%; transform: translateX(-50%); }
        .btn-left { left: -11px; top: 50%; transform: translateY(-50%); }
        .btn-right { right: -11px; top: 50%; transform: translateY(-50%); }

        dialog { border: none; border-radius: 12px; padding: 20px; width: 90%; max-width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.8rem; color: #64748b; margin-bottom: 4px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-red { background: #ef4444; color: white; }
        .btn-blue { background: var(--primary); color: white; }
    </style>
</head>
<body>

<header>
    <h3 style="margin:0">Family Tree</h3>
    <button class="btn btn-red" onclick="resetAll()">Reset All Data</button>
</header>

<div id="viewport">
    <canvas id="canvas"></canvas>
    <div id="nodes-container"></div>
</div>

<dialog id="nodeDialog">
    <h3 id="modalTitle">Add Member</h3>
    <form id="nodeForm">
        <div class="form-group">
            <label>Relation to selected:</label>
            <input type="text" id="displayRelation" disabled style="background:#f1f5f9">
        </div>
        <div class="form-group"><label>Name</label><input type="text" id="name" required></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="phone"></div>
        <div class="form-group"><label>Photo</label><input type="file" id="photo" accept="image/*"></div>
        
        <input type="hidden" id="refId">
        <input type="hidden" id="relationType">
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button type="button" class="btn" onclick="nodeDialog.close()">Cancel</button>
            <button type="submit" class="btn btn-blue">Save Member</button>
        </div>
    </form>
</dialog>

<script>
    const DEFAULT_DATA = [{ id: 'me', name: 'Me', phone: '', photo: '', parents: [], children: [], siblings: [] }];
    let family = JSON.parse(localStorage.getItem('myFamilyData')) || DEFAULT_DATA;

    const container = document.getElementById('nodes-container');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const dialog = document.getElementById('nodeDialog');

    function render() {
        container.innerHTML = '';
        const positions = calculatePositions();
        
        family.forEach(member => {
            const pos = positions[member.id] || { x: 2500, y: 2500 };
            member.x = pos.x; member.y = pos.y;

            const div = document.createElement('div');
            div.className = `node ${member.id === 'me' ? 'me' : ''}`;
            div.style.left = `${pos.x}px`;
            div.style.top = `${pos.y}px`;
            
            div.innerHTML = `
                <div class="node-img" style="background-image:url(${member.photo || ''}); background-size:cover"></div>
                <div class="node-name">${member.name}</div>
                <div class="btn-add btn-top" onclick="event.stopPropagation(); openAdd('${member.id}', 'parent')">↑</div>
                <div class="btn-add btn-bottom" onclick="event.stopPropagation(); openAdd('${member.id}', 'child')">↓</div>
                <div class="btn-add btn-left" onclick="event.stopPropagation(); openAdd('${member.id}', 'sibling')">←</div>
                <div class="btn-add btn-right" onclick="event.stopPropagation(); openAdd('${member.id}', 'sibling')">→</div>
            `;
            container.appendChild(div);
        });
        drawLines();
    }

    function calculatePositions() {
        const pos = {};
        const visited = new Set();
        const gapX = 220, gapY = 180;

        function walk(id, x, y) {
            if (visited.has(id)) return;
            visited.add(id);
            pos[id] = { x, y };

            const m = family.find(f => f.id === id);
            if (!m) return;

            m.parents.forEach((pId, i) => walk(pId, x + (i * 50), y - gapY));
            m.children.forEach((cId, i) => walk(cId, x + (i * 50), y + gapY));
            m.siblings.forEach((sId, i) => walk(sId, x + gapX, y));
        }

        walk('me', 2400, 2400); // Start from center of large container
        return pos;
    }

    function drawLines() {
        canvas.width = 5000; canvas.height = 5000;
        ctx.clearRect(0, 0, 5000, 5000);
        ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 2;

        family.forEach(m => {
            m.children.forEach(cId => {
                const child = family.find(f => f.id === cId);
                if (child) {
                    ctx.beginPath();
                    ctx.moveTo(m.x + 75, m.y + 70);
                    ctx.lineTo(child.x + 75, child.y);
                    ctx.stroke();
                }
            });
            m.siblings.forEach(sId => {
                const sib = family.find(f => f.id === sId);
                if (sib) {
                    ctx.beginPath();
                    ctx.moveTo(m.x + 150, m.y + 35);
                    ctx.lineTo(sib.x, sib.y + 35);
                    ctx.stroke();
                }
            });
        });
    }

    function openAdd(id, type) {
        document.getElementById('refId').value = id;
        document.getElementById('relationType').value = type;
        document.getElementById('displayRelation').value = type.toUpperCase();
        document.getElementById('name').value = '';
        dialog.showModal();
    }

    document.getElementById('nodeForm').onsubmit = async (e) => {
        e.preventDefault();
        const refId = document.getElementById('refId').value;
        const type = document.getElementById('relationType').value;
        const newId = 'n' + Date.now();
        
        const newMember = {
            id: newId,
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            photo: '', parents: [], children: [], siblings: []
        };

        const refMember = family.find(f => f.id === refId);
        if (type === 'parent') { refMember.parents.push(newId); newMember.children.push(refId); }
        if (type === 'child') { refMember.children.push(newId); newMember.parents.push(refId); }
        if (type === 'sibling') { refMember.siblings.push(newId); newMember.siblings.push(refId); }

        const photoFile = document.getElementById('photo').files[0];
        if (photoFile) {
            newMember.photo = await new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => r(e.target.result);
                reader.readAsDataURL(photoFile);
            });
        }

        family.push(newMember);
        localStorage.setItem('myFamilyData', JSON.stringify(family));
        dialog.close();
        render();
    };

    function resetAll() {
        if (confirm("This will delete the entire tree. Proceed?")) {
            localStorage.removeItem('myFamilyData');
            family = [...DEFAULT_DATA];
            render();
        }
    }

    // Scroll to center on load
    window.onload = () => {
        render();
        const vp = document.getElementById('viewport');
        vp.scrollLeft = 2500 - (window.innerWidth / 2);
        vp.scrollTop = 2500 - (window.innerHeight / 2);
    };
</script>
</body>
</html>