<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Tree App</title>
    <style>
        :root { 
            --primary: #2563eb; 
            --spouse: #ec4899; 
            --bg: #f1f5f9; 
            --card: #ffffff; 
            --text: #1e293b; 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; background: var(--bg); color: var(--text); }
        
        header { 
            position: fixed; top: 0; width: 100%; padding: 12px 20px; 
            background: white; border-bottom: 1px solid #e2e8f0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }

        #viewport { width: 100vw; height: 100vh; overflow: auto; cursor: grab; position: relative; }
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        #nodes-container { position: absolute; width: 5000px; height: 5000px; }

        .node {
            position: absolute; width: 160px; background: var(--card);
            padding: 12px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            text-align: center; border: 1px solid #e2e8f0; z-index: 10;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
        }
        .node:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .node.me { border: 2px solid var(--primary); }

        .node-img { width: 60px; height: 60px; background: #cbd5e1; border-radius: 50%; margin: 0 auto 8px; background-size: cover; background-position: center; pointer-events: none; }
        .node-name { font-weight: bold; font-size: 0.95rem; margin: 0; pointer-events: none; }
        .node-phone { font-size: 0.75rem; color: #64748b; margin-top: 4px; pointer-events: none; }
        
        /* Expansion Buttons */
        .btn-add {
            position: absolute; width: 26px; height: 26px; background: var(--primary);
            color: white; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 18px; cursor: pointer; border: 2px solid white;
            z-index: 20; transition: transform 0.2s;
        }
        .btn-add:hover { transform: scale(1.3); background: #1d4ed8; }
        .btn-top { top: -13px; left: 50%; transform: translateX(-50%); }
        .btn-bottom { bottom: -13px; left: 50%; transform: translateX(-50%); }
        .btn-left { left: -13px; top: 50%; transform: translateY(-50%); }
        .btn-right { right: -13px; top: 50%; transform: translateY(-50%); }
        .btn-spouse { bottom: -10px; right: -5px; background: var(--spouse); font-size: 14px; }

        dialog { border: none; border-radius: 16px; padding: 24px; width: 90%; max-width: 380px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-reset { background: #fee2e2; color: #b91c1c; }
        .btn-save { background: var(--primary); color: white; flex: 1; }
        .btn-cancel { background: #f1f5f9; color: #475569; flex: 1; }
    </style>
</head>
<body>

<header>
    <div><h3 style="margin:0">Family Tree</h3><small id="memberCount">1 Member</small></div>
    <button class="btn btn-reset" onclick="resetAll()">Reset Tree</button>
</header>

<div id="viewport">
    <canvas id="canvas"></canvas>
    <div id="nodes-container"></div>
</div>

<dialog id="nodeDialog">
    <h3 id="modalTitle" style="margin-top:0">Family Member</h3>
    <form id="nodeForm">
        <div class="form-group" id="relationField">
            <label>Relation:</label>
            <input type="text" id="displayRel" disabled style="background:#f8fafc; color: var(--primary); font-weight: bold;">
        </div>
        <div class="form-group"><label>Full Name</label><input type="text" id="name" required></div>
        <div class="form-group"><label>Phone Number</label><input type="tel" id="phone"></div>
        <div class="form-group"><label>Photo</label><input type="file" id="photoInput" accept="image/*"></div>
        
        <input type="hidden" id="nodeId"><input type="hidden" id="refId"><input type="hidden" id="relType">
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button type="button" class="btn btn-cancel" onclick="nodeDialog.close()">Cancel</button>
            <button type="submit" class="btn btn-save">Save</button>
        </div>
    </form>
</dialog>

<script>
    const STORAGE_KEY = 'family_tree_final';
    const DEFAULT = [{ id: 'me', name: 'Me', phone: '', photo: '', parents: [], children: [], siblings: [], spouses: [] }];
    let family = JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT;

    const container = document.getElementById('nodes-container');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const dialog = document.getElementById('nodeDialog');

    function render() {
        container.innerHTML = '';
        document.getElementById('memberCount').innerText = `${family.length} Members`;
        const positions = calculatePositions();
        
        family.forEach(m => {
            const p = positions[m.id] || { x: 2500, y: 2500 };
            m.x = p.x; m.y = p.y;

            const card = document.createElement('div');
            card.className = `node ${m.id === 'me' ? 'me' : ''}`;
            card.style.left = `${p.x}px`;
            card.style.top = `${p.y}px`;
            
            // Set up main card click (EDIT)
            card.onclick = () => openEdit(m.id);

            card.innerHTML = `
                <div class="node-img" style="background-image:url(${m.photo || ''})"></div>
                <p class="node-name">${m.name}</p>
                <p class="node-phone">${m.phone || ''}</p>
                <div class="btn-add btn-top" title="Add Parent" onclick="event.stopPropagation(); openAdd('${m.id}', 'parent')">↑</div>
                <div class="btn-add btn-bottom" title="Add Child" onclick="event.stopPropagation(); openAdd('${m.id}', 'child')">↓</div>
                <div class="btn-add btn-left" title="Add Sibling" onclick="event.stopPropagation(); openAdd('${m.id}', 'sibling')">←</div>
                <div class="btn-add btn-right" title="Add Sibling" onclick="event.stopPropagation(); openAdd('${m.id}', 'sibling')">→</div>
                <div class="btn-add btn-spouse" title="Add Spouse" onclick="event.stopPropagation(); openAdd('${m.id}', 'spouse')">❤️</div>
            `;
            container.appendChild(card);
        });
        drawLines();
    }

    function calculatePositions() {
        const pos = {}; const visited = new Set();
        const gX = 220, gY = 200;

        function walk(id, x, y) {
            if (visited.has(id)) return;
            visited.add(id);
            pos[id] = { x, y };
            const m = family.find(f => f.id === id);
            if (!m) return;

            m.parents.forEach((pid, i) => walk(pid, x + (i * 40), y - gY));
            m.children.forEach((cid, i) => walk(cid, x + (i * 40), y + gY));
            m.siblings.forEach((sid, i) => walk(sid, x + gX, y));
            m.spouses.forEach((sid, i) => walk(sid, x + gX, y));
        }
        walk('me', 2420, 2400);
        return pos;
    }

    function drawLines() {
        canvas.width = 5000; canvas.height = 5000;
        ctx.clearRect(0, 0, 5000, 5000);
        family.forEach(m => {
            ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 2;
            m.children.forEach(cid => {
                const c = family.find(f => f.id === cid);
                if(c){ ctx.beginPath(); ctx.moveTo(m.x+80, m.y+100); ctx.lineTo(c.x+80, c.y); ctx.stroke(); }
            });
            ctx.setLineDash([5, 5]);
            m.siblings.forEach(sid => {
                const s = family.find(f => f.id === sid);
                if(s){ ctx.beginPath(); ctx.moveTo(m.x+160, m.y+50); ctx.lineTo(s.x, s.y+50); ctx.stroke(); }
            });
            ctx.setLineDash([]);
            ctx.strokeStyle = '#f472b6';
            m.spouses.forEach(sid => {
                const s = family.find(f => f.id === sid);
                if(s){ ctx.beginPath(); ctx.moveTo(m.x+160, m.y+80); ctx.lineTo(s.x, s.y+80); ctx.stroke(); }
            });
        });
    }

    // Modal Handlers
    function openAdd(id, type) {
        document.getElementById('nodeForm').reset();
        document.getElementById('modalTitle').innerText = "Add " + type.charAt(0).toUpperCase() + type.slice(1);
        document.getElementById('relationField').style.display = 'block';
        document.getElementById('displayRel').value = type.toUpperCase();
        document.getElementById('refId').value = id;
        document.getElementById('relType').value = type;
        document.getElementById('nodeId').value = ""; // Clear for new member
        dialog.showModal();
    }

    function openEdit(id) {
        const m = family.find(f => f.id === id);
        if(!m) return;
        document.getElementById('modalTitle').innerText = "Edit Details";
        document.getElementById('relationField').style.display = 'none';
        document.getElementById('nodeId').value = m.id;
        document.getElementById('name').value = m.name;
        document.getElementById('phone').value = m.phone;
        dialog.showModal();
    }

    document.getElementById('nodeForm').onsubmit = async (e) => {
        e.preventDefault();
        const existingId = document.getElementById('nodeId').value;
        const refId = document.getElementById('refId').value;
        const type = document.getElementById('relType').value;
        const photoFile = document.getElementById('photoInput').files[0];

        let target;
        if (existingId) {
            // EDITING EXISTING
            target = family.find(f => f.id === existingId);
        } else {
            // ADDING NEW
            const newId = 'n' + Date.now();
            target = { id: newId, name: '', phone: '', photo: '', parents: [], children: [], siblings: [], spouses: [] };
            family.push(target);
            
            const refM = family.find(f => f.id === refId);
            if (type === 'parent') { refM.parents.push(newId); target.children.push(refId); }
            else if (type === 'child') { refM.children.push(newId); target.parents.push(refId); }
            else if (type === 'sibling') { refM.siblings.push(newId); target.siblings.push(refId); }
            else if (type === 'spouse') { refM.spouses.push(newId); target.spouses.push(refId); }
        }

        target.name = document.getElementById('name').value;
        target.phone = document.getElementById('phone').value;

        if (photoFile) {
            target.photo = await new Promise(r => {
                const rd = new FileReader(); rd.onload = ev => r(ev.target.result); rd.readAsDataURL(photoFile);
            });
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(family));
        dialog.close();
        render();
    };

    function resetAll() {
        if(confirm("Erase tree data?")) { localStorage.clear(); location.reload(); }
    }

    window.onload = () => {
        render();
        const v = document.getElementById('viewport');
        v.scrollLeft = 2500 - (window.innerWidth / 2);
        v.scrollTop = 2500 - (window.innerHeight / 2);
    };
</script>
</body>
</html>
