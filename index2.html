<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Family Tree</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#f3f4f6;
}
header{
  position:sticky;top:0;
  background:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  z-index:10;
}
button{
  border:none;
  padding:8px 12px;
  border-radius:8px;
  background:#4f46e5;
  color:#fff;
  cursor:pointer;
}
button.secondary{
  background:#e5e7eb;color:#111;
}
#tree-wrapper{
  position:relative;
  height:calc(100vh - 56px);
  overflow:auto;
}
canvas{
  position:absolute;inset:0;
  z-index:0;
}
#tree{
  position:relative;
  min-width:2000px;
  min-height:1200px;
  z-index:1;
}
.node{
  position:absolute;
  width:150px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  padding:10px;
  text-align:center;
}
.photo{
  width:56px;height:56px;
  border-radius:50%;
  background:#e5e7eb;
  margin:auto;
  overflow:hidden;
}
.photo img{width:100%;height:100%;object-fit:cover}
.name{font-weight:600;margin-top:6px}

.controls{position:absolute;inset:0;pointer-events:none}
.ctrl{
  position:absolute;
  width:22px;height:22px;
  border-radius:50%;
  background:#4f46e5;
  color:#fff;
  font-size:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  pointer-events:auto;
}
.ctrl.top{top:-12px;left:50%;transform:translateX(-50%)}
.ctrl.bottom{bottom:-12px;left:50%;transform:translateX(-50%)}
.ctrl.left{left:-12px;top:50%;transform:translateY(-50%)}
.ctrl.right{right:-12px;top:50%;transform:translateY(-50%)}
.ctrl.spouse{
  right:-36px;top:50%;
  transform:translateY(-50%);
  background:#ec4899;
}

dialog{
  border:none;
  border-radius:12px;
  padding:16px;
  width:90%;
  max-width:360px;
}
dialog form{display:flex;flex-direction:column;gap:8px}
dialog input{
  padding:8px;
  border-radius:6px;
  border:1px solid #d1d5db;
}
dialog::backdrop{background:rgba(0,0,0,.4)}
</style>
</head>

<body>

<header>
  <h3>üå≥ Family Tree</h3>
  <div>
    <button class="secondary" onclick="resetTree()">Reset</button>
    <button onclick="broadcast()">Broadcast</button>
  </div>
</header>

<div id="tree-wrapper">
  <canvas id="lines"></canvas>
  <div id="tree"></div>
</div>

<dialog id="personDialog">
  <form method="dialog">
    <h4 id="dialogTitle"></h4>
    <input type="hidden" id="baseId">
    <input type="hidden" id="relation">
    <input id="name" placeholder="Name" required>
    <input id="email" placeholder="Email">
    <input id="phone" placeholder="Phone">
    <input id="photo" type="file" accept="image/*">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button value="cancel" class="secondary">Cancel</button>
      <button onclick="save()">Save</button>
    </div>
  </form>
</dialog>

<script>
const treeEl=document.getElementById("tree");
const canvas=document.getElementById("lines");
const ctx=canvas.getContext("2d");
const dialog=document.getElementById("personDialog");

let data=JSON.parse(localStorage.getItem("familyTree"))||[
  {id:1,name:"Me",email:"",phone:"",photo:"",parentID:null,spouseID:null}
];

let pos={};

function resetTree(){
  if(confirm("Reset entire family tree?")){
    localStorage.clear();
    location.reload();
  }
}

function level(p){
  if(!p.parentID) return 0;
  const par=data.find(x=>x.id===p.parentID);
  return par?level(par)+1:0;
}

function layout(){
  pos={};
  const levels={};
  data.forEach(p=>{
    const l=level(p);
    (levels[l]??=[]).push(p);
  });
  Object.entries(levels).forEach(([l,arr])=>{
    arr.forEach((p,i)=>{
      pos[p.id]={x:i*260+200,y:l*220+120};
    });
  });

  data.forEach(p=>{
    if(p.spouseID && pos[p.id] && !pos[p.spouseID]){
      pos[p.spouseID]={x:pos[p.id].x+180,y:pos[p.id].y};
    }
  });
}

function render(){
  treeEl.innerHTML="";
  layout();
  resizeCanvas();
  drawLines();

  data.forEach(p=>{
    const d=document.createElement("div");
    d.className="node";
    d.style.left=pos[p.id].x+"px";
    d.style.top=pos[p.id].y+"px";
    d.innerHTML=`
      <div class="photo">${p.photo?`<img src="${p.photo}">`:""}</div>
      <div class="name">${p.name}</div>
      <div class="controls">
        <div class="ctrl top" onclick="openAdd(${p.id},'parent')">+</div>
        <div class="ctrl bottom" onclick="openAdd(${p.id},'child')">+</div>
        <div class="ctrl left" onclick="openAdd(${p.id},'sibling')">+</div>
        <div class="ctrl right" onclick="openAdd(${p.id},'sibling')">+</div>
        ${!p.spouseID?`<div class="ctrl spouse" onclick="openAdd(${p.id},'spouse')">‚ù§Ô∏è</div>`:""}
      </div>
    `;
    d.onclick=()=>edit(p.id);
    treeEl.appendChild(d);
  });

  localStorage.setItem("familyTree",JSON.stringify(data));
}

function resizeCanvas(){
  canvas.width=treeEl.scrollWidth;
  canvas.height=treeEl.scrollHeight;
}

function drawLines(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#9ca3af";
  ctx.lineWidth=2;

  // parent-child
  data.forEach(p=>{
    if(p.parentID){
      const a=pos[p.parentID],b=pos[p.id];
      if(!a||!b)return;
      ctx.beginPath();
      ctx.moveTo(a.x+75,a.y+150);
      ctx.lineTo(b.x+75,b.y);
      ctx.stroke();
    }
  });

  // spouse
  ctx.setLineDash([6,4]);
  data.forEach(p=>{
    if(p.spouseID && p.id<p.spouseID){
      const a=pos[p.id],b=pos[p.spouseID];
      if(!a||!b)return;
      ctx.beginPath();
      ctx.moveTo(a.x+150,a.y+75);
      ctx.lineTo(b.x,b.y+75);
      ctx.stroke();
    }
  });
  ctx.setLineDash([]);
}

function openAdd(id,rel){
  dialogTitle.textContent=`Add ${rel.toUpperCase()} of ${data.find(p=>p.id===id).name}`;
  baseId.value=id;
  relation.value=rel;
  name.value=email.value=phone.value="";
  photo.value="";
  dialog.showModal();
}

function edit(id){
  const p=data.find(x=>x.id===id);
  dialogTitle.textContent=`Edit ${p.name}`;
  baseId.value=id;
  relation.value="edit";
  name.value=p.name;
  email.value=p.email;
  phone.value=p.phone;
  dialog.showModal();
}

function save(){
  const rel=relation.value;
  const id=+baseId.value;

  if(rel==="edit"){
    const p=data.find(x=>x.id===id);
    p.name=name.value;p.email=email.value;p.phone=phone.value;
    loadPhoto(p);return;
  }

  if(rel==="spouse"){
    const base=data.find(p=>p.id===id);
    const sp={id:Date.now(),name:name.value,email:email.value,phone:phone.value,photo:"",
      parentID:base.parentID,spouseID:base.id};
    base.spouseID=sp.id;
    data.push(sp);
    loadPhoto(sp);return;
  }

  const n={id:Date.now(),name:name.value,email:email.value,phone:phone.value,photo:"",parentID:null,spouseID:null};
  if(rel==="child") n.parentID=id;
  if(rel==="sibling") n.parentID=data.find(p=>p.id===id).parentID;
  if(rel==="parent"){
    n.parentID=data.find(p=>p.id===id).parentID;
    data.find(p=>p.id===id).parentID=n.id;
  }
  data.push(n);
  loadPhoto(n);
}

function loadPhoto(p){
  if(photo.files[0]){
    const r=new FileReader();
    r.onload=()=>{p.photo=r.result;render()}
    r.readAsDataURL(photo.files[0]);
  } else render();
}

function broadcast(){
  const phones=data.map(p=>p.phone).filter(Boolean);
  if(!phones.length) return alert("No phone numbers");
  window.location.href=`https://wa.me/?text=${encodeURIComponent("Family update!")}`;
}

render();
</script>

</body>
</html>